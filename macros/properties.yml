version: 2

macros:
  - name: bucket_map
    description: '{{ doc("bucket_map") }}'
    arguments:
      - name: relation
        type: relation | sql
        description: Pre-filtered input relation to analyze (CTE or table/view).
      - name: category_expr
        type: sql
        description: SQL expression yielding the raw category (e.g., LOWER(channel)).
      - name: policy
        type: string
        description: One of 'pareto' | 'top_k' | 'min_threshold'. Default 'pareto'.
      - name: coverage
        type: float
        description: Pareto coverage threshold (0–1). Used when policy='pareto'. Default 0.80.
      - name: k
        type: integer
        description: Number of categories to keep when policy='top_k'. Optional.
      - name: min_share
        type: float
        description: Minimum row-share (0–1) when policy='min_threshold'. Default 0.05.
      - name: pins
        type: array<string>
        description: Raw category values to always keep as their own bucket.
      - name: min_categories
        type: integer
        description: Minimum number of buckets to keep (kept + `__other__`). Ensures width; default 3.
      - name: other_label
        type: string
        description: Label used for the pooled bucket. Default '__other__'.
      - name: tiebreaker
        type: string
        description: >
          Tie resolution: 'alpha' (lexicographic) or 'version' (natural/semver-like). Default 'alpha'.
      - name: rank_by_metric
        type: sql | null
        description: >
          If null, categories are ranked by frequency (COUNT(*)). If provided,
          this must be a complete SQL aggregation (e.g., SUM(sales),
          AVG(revenue_per_user), COUNTIF(is_converted)) used for ranking and for
          `metric_value`/`metric_share`.

  - name: bigquery__bucket_map
    description: '{{ doc("bigquery__bucket_map") }}'

  - name: default__bucket_map
    description: '{{ doc("default__bucket_map") }}'

  - name: apply_bucket_map
    description: '{{ doc("apply_bucket_map") }}'
    arguments:
      - name: relation
        type: relation | sql
        description: Source relation whose rows should be bucket-labelled.
      - name: category_expr
        type: sql
        description: Expression pointing to the raw category in `relation`.
      - name: bucket_map_relation
        type: relation | sql
        description: Mapping relation produced by `bucket_map`.
      - name: bucket_field
        type: string
        description: Column in the map to use as the bucket label. Default 'bucket'.
      - name: category_key
        type: string
        description: Column in the map holding the normalized category. Default 'category_raw'.
      - name: passthrough_columns
        type: array<string>
        description: Additional map columns to project, e.g. ['kept', 'pinned'].
      - name: other_label
        type: string
        description: Fallback bucket label when a category is missing. Default '__other__'.

  - name: bigquery__apply_bucket_map
    description: '{{ doc("bigquery__apply_bucket_map") }}'

  - name: default__apply_bucket_map
    description: '{{ doc("default__apply_bucket_map") }}'
